<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Language" content="en">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Teleprompter 2.0</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"/>
    <meta name="description" content="This is an example dashboard created using build-in elements and components.">
    <meta name="msapplication-tap-highlight" content="no">
    <!--
    =========================================================
    * ArchitectUI HTML Theme Dashboard - v1.0.0
    =========================================================
    * Product Page: https://dashboardpack.com
    * Copyright 2019 DashboardPack (https://dashboardpack.com)
    * Licensed under MIT (https://github.com/DashboardPack/architectui-html-theme-free/blob/master/LICENSE)
    =========================================================
    * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
    -->
    <link href="./main.css" rel="stylesheet">
    <link href="./css/dashboard.css" rel="stylesheet">
</head>
<body>
<div class="app-container app-theme-white body-tabs-shadow fixed-sidebar fixed-header">
    <div class="app-header header-shadow bg-vicious-stance header-text-light">
        <div class="app-header__logo">
            <div class="logo-src" style="display: none"></div>
            <div class="header__pane ml-auto">
                <div>
                    <button type="button" class="hamburger close-sidebar-btn hamburger--elastic"
                            data-class="closed-sidebar">
                            <span class="hamburger-box">
                                <span class="hamburger-inner"></span>
                            </span>
                    </button>
                </div>
            </div>
        </div>
        <div class="app-header__mobile-menu">
            <div>
                <button type="button" class="hamburger hamburger--elastic mobile-toggle-nav">
                        <span class="hamburger-box">
                            <span class="hamburger-inner"></span>
                        </span>
                </button>
            </div>
        </div>
        <div class="app-header__menu">
                <span>
                    <button type="button"
                            class="btn-icon btn-icon-only btn btn-primary btn-sm mobile-toggle-header-nav">
                        <span class="btn-icon-wrapper">
                            <i class="fa fa-ellipsis-v fa-w-6"></i>
                        </span>
                    </button>
                </span>
        </div>
        <div class="app-header__content">
            <div class="app-header-left">

                <ul class="header-menu nav">

                </ul>
            </div>
        </div>
    </div>
    <div class="app-main">
        <div class="app-sidebar sidebar-shadow bg-vicious-stance sidebar-text-light">
            <div class="app-header__logo">
                <div class="logo-src"></div>
                <div class="header__pane ml-auto">
                    <div>
                        <button type="button" class="hamburger close-sidebar-btn hamburger--elastic"
                                data-class="closed-sidebar">
                                    <span class="hamburger-box">
                                        <span class="hamburger-inner"></span>
                                    </span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="app-header__mobile-menu">
                <div>
                    <button type="button" class="hamburger hamburger--elastic mobile-toggle-nav">
                                <span class="hamburger-box">
                                    <span class="hamburger-inner"></span>
                                </span>
                    </button>
                </div>
            </div>
            <div class="app-header__menu">
                        <span>
                            <button type="button"
                                    class="btn-icon btn-icon-only btn btn-primary btn-sm mobile-toggle-header-nav">
                                <span class="btn-icon-wrapper">
                                    <i class="fa fa-ellipsis-v fa-w-6"></i>
                                </span>
                            </button>
                        </span>
            </div>
            <div class="scrollbar-sidebar">
                <div class="app-sidebar__inner">
                    <ul class="vertical-nav-menu">
                        <li class="app-sidebar__heading">Teleprompter</li>
                        <li>
                            <a href="main.html">
                                <i class="metismenu-icon pe-7s-rocket"></i>
                                Live
                            </a>
                        </li>
                        <li class="mm-active">
                            <a href="#">
                                <i class="metismenu-icon pe-7s-tools"></i>
                                Settings
                                <i class="metismenu-state-icon pe-7s-angle-down caret-left"></i>
                            </a>
                            <ul class="mm-show mm-collapse">
                                <li>
                                    <a href="#" class="mm-active">
                                        <i class="metismenu-icon"></i>
                                        Lineup
                                    </a>
                                </li>
                                <li>
                                    <a href="#">
                                        <i class="metismenu-icon"></i>
                                        Streaming
                                    </a>
                                </li>
                                <li>
                                    <a href="#">
                                        <i class="metismenu-icon"></i>
                                        Show
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="app-main__outer">
            <div class="app-main__inner">

                <div class="row">
                    <div class="col-12 col-md-8">
                        <div class="mb-3 card">
                            <div class="card-header-tab card-header-tab-animation card-header">
                                <div class="card-header-title">
                                    <i class="header-icon lnr-apartment icon-gradient bg-love-kiss"> </i>
                                    Lineup - segments
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <button class="mb-2 mr-2 btn-transition btn btn-outline-info max-width" onclick="addTalk()">
                                            Add talk
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="mb-2 mr-2 btn-transition btn btn-outline-secondary max-width" onclick="addSong()">
                                            Add song
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-4">
                        <div class="mb-3 card">
                            <div class="card-header-tab card-header-tab-animation card-header">
                                <div class="card-header-title">
                                    <i class="header-icon lnr-apartment icon-gradient bg-love-kiss"> </i>
                                    Save
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <button class="mb-2 mr-2 btn-transition btn btn-success max-width" onclick="saveChanges();">
                                            Save changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 ">
                        <div class="card mb-3 widget-content">
                            <div class="widget-content-outer">
                                <div class="widget-content-wrapper">
                                    <div class="widget-content-left">
                                        <div class="widget-heading">Total time</div>
                                        <div class="widget-subheading">Calculated show time</div>
                                    </div>
                                    <div class="widget-content-right">
                                        <div class="widget-numbers text-success" id="totalTime">00:00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: none">
                    <div id="talkSegmentTemplate">
                        <div class="row" id="main-##NUMBER##-talk">
                            <div class="col-12">
                                <div class="mb-3 card">
                                    <div class="card-body"><h5 class="card-title">Talk segment</h5>
                                        <div class="form-row">
                                            <div class="col-md-2">
                                                <div class="position-relative form-group">
                                                    <label for="order-##NUMBER##-talk" class="">Order</label>
                                                    <input id="order-##NUMBER##-talk" value="1" type="number" disabled class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="position-relative form-group">
                                                    <label for="title-##NUMBER##-talk" class="">Title</label>
                                                    <input id="title-##NUMBER##-talk" type="text" class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="position-relative form-group">
                                                    <label for="duration-##NUMBER##-talk" class="">Duration</label>
                                                    <input id="duration-##NUMBER##-talk" placeholder="07:00" value="00:00" type="text" class="form-control">
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="card-footer">
                                        <button class="mb-2 mr-2 btn btn-primary" onclick="orderSegment(-1,'##NUMBER##',0)"><i class="fas fa-long-arrow-alt-up"></i></button>
                                        <button class="mb-2 mr-2 btn btn-primary" onclick="orderSegment(1,'##NUMBER##',0)"><i class="fas fa-long-arrow-alt-down"></i></button>
                                        <div class="text-right max-width">
                                            <button class="mb-2 mr-2 btn btn-danger" onclick="deleteSegment('##NUMBER##',0)">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div id="songSegmentTemplate">
                        <div class="row" id="main-##NUMBER##-song">
                            <div class="col-12">
                                <div class="mb-3 card">
                                    <div class="card-body"><h5 class="card-title">Song segment</h5>
                                        <div class="form-row">
                                            <div class="col-md-2">
                                                <div class="position-relative form-group">
                                                    <label for="order-##NUMBER##-song" class="">Order</label>
                                                    <input name="order" id="order-##NUMBER##-song" value="1" type="number" disabled class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="position-relative form-group">
                                                    <label for="file-##NUMBER##-song" class="">Filename</label>
                                                    <select name="select" id="file-##NUMBER##-song" class="form-control">
                                                        <option>sdasdsad.mp3</option>
                                                        <option>okprgre.mp3</option>
                                                        <option>sda.mp3</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="position-relative form-group">
                                                    <label for="duration-##NUMBER##-song" class="">Duration</label>
                                                    <input id="duration-##NUMBER##-song" value="02:22" type="text" disabled class="form-control">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="col-md-5">
                                                <div class="position-relative form-group">
                                                    <label for="title-##NUMBER##-song" class="">Song title</label>
                                                    <input name="order" id="title-##NUMBER##-song" type="text" class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="position-relative form-group">
                                                    <label for="author-##NUMBER##-song" class="">Song author</label>
                                                    <input name="password" id="author-##NUMBER##-song" type="text" class="form-control">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="position-relative form-group">
                                                    <label for="still-##NUMBER##-song" class="">Still number</label>
                                                    <input id="still-##NUMBER##-song" min="0" max="20" value="0" type="number" class="form-control">
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="card-footer">
                                        <button class="mb-2 mr-2 btn btn-primary" onclick="orderSegment(-1,'##NUMBER##',1)"><i class="fas fa-long-arrow-alt-up"></i></button>
                                        <button class="mb-2 mr-2 btn btn-primary" onclick="orderSegment(1,'##NUMBER##',1)"><i class="fas fa-long-arrow-alt-down"></i></button>
                                        <div class="text-right max-width">
                                            <button class="mb-2 mr-2 btn btn-danger" onclick="deleteSegment('##NUMBER##',1)">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div id="segmentsContainer"></div>

            </div>
        </div>

    </div>
</div>

<script type="text/javascript" src="./assets/scripts/main.js"></script>
<script type="text/javascript" src="./font-awesome/js/all.min.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>

<script type="text/javascript">

    window.$ = window.jQuery = require('./js/jquery.min.js');

    let INCREMENT_INDEX = 0;

    let segments = [];
    let songs = {};

    const {ipcRenderer} = require('electron');

    (async ()=>{

        let response = await backendCommand("getSongs",{});

        let fileSelector = document.getElementById("file-##NUMBER##-song");

        fileSelector.innerHTML = "";

        response.forEach((file)=>{
            fileSelector.innerHTML = fileSelector.innerHTML + `<option>${file.filename}</option>`;
            songs[file.filename] = file.duration;
        });

        let segmentsJson = await backendCommand("loadSegments",{});
        loadSegments(segmentsJson);

        calculateTotalTime();
    })();

    function onSelectChange(){

        let id = parseInt($(this).attr('id').replaceAll(/file-/gi,"").replaceAll(/-song/gi,""));

        let duration = songs[$(this).val()];

        jQuery(`#duration-${id}-song`).val(`${formatNumber(duration.minutes)}:${formatNumber(duration.seconds)}`);
        calculateTotalTime();
        console.log(duration);
    }

    function onDurationChange(){
        calculateTotalTime();
    }

    function orderSegment(direction,index,type){
        for(let i = 0; i< segments.length;i++){
            let segment = segments[i];
            if(segment["id"] === index+"" && type === segment["type"]){
                let currentOrder = i;

                if(currentOrder === 0 && direction < 0 )return; //If it's the first and it's going down do nothing
                if(currentOrder === segments.length-1 && direction > 0)return;  //If it's the last and it's going up do nothing

                let tmp = segments[currentOrder];
                segments[currentOrder] = segments[currentOrder+direction];
                segments[currentOrder+direction] = tmp;

                if(type === 0){
                    //Talk
                    jQuery("#order-"+index+"-talk").val(currentOrder+direction);

                    let elem = jQuery("#main-"+index+"-talk");

                    if(direction > 0){
                        elem.insertAfter(elem.next());
                    }else{
                        elem.insertBefore(elem.prev());
                    }

                }else{
                    //Song
                    jQuery("#order-"+index+"-song").val(currentOrder+direction);

                    let elem = jQuery("#main-"+index+"-song");

                    if(direction > 0){
                        elem.insertAfter(elem.next());
                    }else{
                        elem.insertBefore(elem.prev());
                    }
                }

                if(segments[currentOrder]["type"]===0){
                    jQuery("#order-"+segments[currentOrder]["id"]+"-talk").val(currentOrder);
                }else {
                    jQuery("#order-"+segments[currentOrder]["id"]+"-song").val(currentOrder);
                }


                return;
            }
        }
    }

    function deleteSegment(index,type){
        for(let i = 0; i< segments.length;i++){
            let segment = segments[i];
            if(segment["id"] === index+"" && type === segment["type"]){
                let newSegments = [];
                for(let j=0;j<segments.length;j++){
                    if(j===i)continue;
                    newSegments.push(segments[j]);
                }
                segments = newSegments;
                if(type === 0){
                    jQuery("#main-"+index+"-talk").remove();
                }else{
                    jQuery("#main-"+index+"-song").remove();
                }
                return;
            }
        }
    }

    function addTalk(){
        let template = jQuery("#talkSegmentTemplate").html();
        template  = template.replace(/##NUMBER##/g, ""+INCREMENT_INDEX);
        INCREMENT_INDEX++;
        jQuery("#segmentsContainer").append(template);

        jQuery("#order-"+(INCREMENT_INDEX-1)+"-talk").val(segments.length);

        jQuery("#duration-"+(INCREMENT_INDEX-1)+"-talk").change(onDurationChange);

        segments.push({
            id: ""+(INCREMENT_INDEX-1),
            type: 0
        });

        return (INCREMENT_INDEX-1);
    }

    function addSong(){
        let template = jQuery("#songSegmentTemplate").html();
        template  = template.replace(/##NUMBER##/g, ""+INCREMENT_INDEX);
        INCREMENT_INDEX++;
        jQuery("#segmentsContainer").append(template);
        jQuery("#order-"+(INCREMENT_INDEX-1)+"-song").val(segments.length);
        let selector = jQuery("#file-"+(INCREMENT_INDEX-1)+"-song");
        selector.change(onSelectChange);

        let duration = songs[selector.val()];

        jQuery(`#duration-${INCREMENT_INDEX-1}-song`).val(`${formatNumber(duration.minutes)}:${formatNumber(duration.seconds)}`);

        jQuery("#duration-"+(INCREMENT_INDEX-1)+"-song").change(onDurationChange);
        segments.push({
            id: ""+(INCREMENT_INDEX-1),
            type: 1
        });

        return (INCREMENT_INDEX-1);
    }

    function loadSegments(jsonSegments){
        jsonSegments.forEach((segment)=>{

            if(segment.type === 0){
                //Talk segment
                let id = addTalk();

                jQuery(`#title-${id}-talk`).val(segment.title);
                jQuery(`#duration-${id}-talk`).val(segment.duration);

            }else if(segment.type === 1){
                //Song segment
                let id = addSong();

                jQuery(`#title-${id}-song`).val(segment.title);
                jQuery(`#author-${id}-song`).val(segment.author);
                jQuery(`#still-${id}-song`).val(segment.still);

                let duration = songs[segment.filename];
                if(duration !== undefined){
                    jQuery(`#file-${id}-song`).val(segment.filename);
                    jQuery(`#duration-${id}-song`).val(`${formatNumber(duration.minutes)}:${formatNumber(duration.seconds)}`);
                }else{
                    jQuery(`#file-${id}-song`).val("");
                    jQuery(`#duration-${id}-song`).val(`00:00`);
                }
            }

        });
    }

    function formatNumber(number){
        if(number<10){
            return "0"+number;
        }
        return number;
    }

    async function backendCommand(command,options){
        return new Promise(((resolve) => {
            let listener = (event, response) => {
                ipcRenderer.removeListener(command,listener);
                resolve(response);
            };
            ipcRenderer.on(command, listener);
            ipcRenderer.send(command, options);
        }));
    }

    function saveChanges(){
        let elements = [];
        segments.forEach((segment)=>{

            let element = {
                type: segment.type
            };

            if(segment.type === 0){
                //Talk segment

                element.order = jQuery(`#order-${segment.id}-talk`).val();
                element.title = jQuery(`#title-${segment.id}-talk`).val();
                element.duration = jQuery(`#duration-${segment.id}-talk`).val();

            }else if(segment.type === 1){
                //Song segment

                element.order = jQuery(`#order-${segment.id}-song`).val();
                element.duration = jQuery(`#duration-${segment.id}-song`).val();
                element.title = jQuery(`#title-${segment.id}-song`).val();
                element.author = jQuery(`#author-${segment.id}-song`).val();
                element.filename = jQuery(`#file-${segment.id}-song`).val();
                element.still = jQuery(`#still-${segment.id}-song`).val();
            }

            elements.push(element);

        });

        backendCommand("saveSegments",elements).then((response)=>{
            console.log(response);
        });
    }

    function calculateTotalTime(){

        let minutes = 0;
        let seconds = 0;

        segments.forEach((segment)=>{
            if(segment.type === 0){
                //Talk segment

                let duration = jQuery(`#duration-${segment.id}-talk`).val().split(":");

                minutes += parseInt(duration[0]);
                seconds += parseInt(duration[1]);

            }else if(segment.type === 1){
                //Song segment

                let duration = jQuery(`#duration-${segment.id}-song`).val().split(":");

                minutes += parseInt(duration[0]);
                seconds += parseInt(duration[1]);
            }
            if(seconds > 59){
                minutes++;
                seconds = seconds-60;
            }
        })

        console.log({
            minutes: minutes,
            seconds: seconds
        })

        jQuery(`#totalTime`).html(`${formatNumber(minutes)}:${formatNumber(seconds)}`);
    }
</script>

</body>
</html>
